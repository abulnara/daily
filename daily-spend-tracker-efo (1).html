<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Daily Spend Tracker for Efo</title>
    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React + ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for in-browser JSX transform -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      // Daily Spend Tracker for Efo — FINAL VERSION v1.0.1 (2025-08-20)
      // Region: Asia/Yerevan

      const key = "daily-spend-tracker-v1";
      const { useState, useEffect, useMemo } = React;

      // ----------------- helpers -----------------
      function formatCurrency(n) {
        if (Number.isNaN(n) || !Number.isFinite(n)) return "–";
        return n.toLocaleString(undefined, { maximumFractionDigits: 0 });
      }

      function daysBetween(start, end) {
        const days = [];
        if (!(start instanceof Date) || !(end instanceof Date)) return days;
        if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return days;
        const d = new Date(start);
        while (d <= end) {
          const label = d.toLocaleDateString(undefined, { month: "long", day: "numeric" });
          days.push(label);
          d.setDate(d.getDate() + 1);
        }
        return days;
      }

      function parseNumber(v) {
        const cleaned = (v || "").toString().replace(/[^0-9.-]/g, "");
        const n = Number(cleaned);
        return Number.isFinite(n) ? n : 0;
      }

      function clamp01(n) {
        if (!Number.isFinite(n)) return 0;
        if (n < 0) return 0;
        if (n > 1) return 1;
        return n;
      }

      function computeBarWidth(percent) {
        const p = clamp01(percent);
        return Math.min(100, Math.max(0, Math.round(p * 100)));
      }

      function makeWeekly(labels, entries, targetAvg) {
        const totalDays = labels.length;
        const out = [];
        for (let i = 0; i < totalDays; i += 7) {
          const span = Math.min(7, totalDays - i);
          let spent = 0;
          for (let j = 0; j < span; j++) {
            const lbl = labels[i + j];
            const v = entries[lbl];
            if (Number.isFinite(v)) spent += v || 0;
          }
          const target = targetAvg * span;
          out.push({ index: out.length + 1, days: span, spent, target });
        }
        return out;
      }

      // ----------------- UI bits -----------------
      function StatCard({ label, value, prefix = "" }) {
        return (
          <div className="p-4 bg-white rounded-2xl shadow">
            <div className="text-xs uppercase tracking-wide text-slate-500 mb-1">{label}</div>
            <div className="text-2xl font-semibold">{typeof value === "number" ? `${prefix}${value}` : `${prefix}${value}`}</div>
          </div>
        );
      }

      function ProgressCard({ title, leftLabel, rightLabel, percent, barClass, caption, truePct }) {
        const pctText = `${Math.round(truePct)}%`;
        const widthPct = computeBarWidth(percent);
        return (
          <div className="p-4 bg-white rounded-2xl shadow">
            <div className="flex items-center justify-between mb-2">
              <div className="font-medium">{title}</div>
              <div className="text-sm text-slate-500">{pctText}</div>
            </div>
            <div className="flex items-center justify-between text-xs text-slate-500 mb-1">
              <span>{leftLabel}</span>
              <span>{rightLabel}</span>
            </div>
            <div className="w-full h-3 bg-slate-200 rounded-full overflow-hidden mb-1">
              <div className={barClass + " h-3"} style={{ width: widthPct + "%" }}></div>
            </div>
            <div className="text-xs text-slate-500">{caption}</div>
          </div>
        );
      }

      // ----------------- main -----------------
      function App() {
        const [startISO, setStartISO] = useState("2025-08-02");
        const [endISO, setEndISO] = useState("2025-08-31");
        const [targetAvg, setTargetAvg] = useState(20000);
        const [planned, setPlanned] = useState(75000);
        const [entries, setEntries] = useState({});
        const [viewMode, setViewMode] = useState("daily"); // 'daily' | 'weekly'

        useEffect(() => {
          document.title = "Daily Spend Tracker for Efo";
        }, []);

        // Load persisted
        useEffect(() => {
          const saved = localStorage.getItem(key);
          if (saved) {
            try {
              const parsed = JSON.parse(saved);
              setStartISO(parsed.startISO ?? startISO);
              setEndISO(parsed.endISO ?? endISO);
              setTargetAvg(parsed.targetAvg ?? targetAvg);
              setPlanned(parsed.planned ?? planned);
              setEntries(parsed.entries ?? {});
            } catch (_) {}
          }
        }, []);

        // Ensure Start <= End
        useEffect(() => {
          const s = new Date(startISO);
          const e = new Date(endISO);
          if (s instanceof Date && e instanceof Date && !Number.isNaN(s.getTime()) && !Number.isNaN(e.getTime())) {
            if (s > e) setEndISO(startISO);
          }
        }, [startISO, endISO]);

        // Persist
        useEffect(() => {
          localStorage.setItem(key, JSON.stringify({ startISO, endISO, targetAvg, planned, entries }));
        }, [startISO, endISO, targetAvg, planned, entries]);

        const startDate = useMemo(() => new Date(startISO + "T00:00:00"), [startISO]);
        const endDate = useMemo(() => new Date(endISO + "T00:00:00"), [endISO]);
        const labels = useMemo(() => daysBetween(startDate, endDate), [startDate, endDate]);

        const totalDays = labels.length;

        // Aggregates
        const spentSoFar = useMemo(() => {
          let sum = 0;
          for (const label of labels) {
            const v = entries[label];
            if (Number.isFinite(v) && v) sum += v;
          }
          return sum;
        }, [labels, entries]);

        const daysFilled = useMemo(() => {
          let count = 0;
          for (const label of labels) {
            const v = entries[label];
            if (Number.isFinite(v) && v !== 0) count += 1;
          }
          return count;
        }, [labels, entries]);

        const targetTotal = targetAvg * totalDays;
        const remainingTotal = Math.max(0, targetTotal - spentSoFar);

        useEffect(() => {
          if (planned > remainingTotal) setPlanned(remainingTotal);
        }, [planned, remainingTotal]);

        const cappedPlanned = Math.min(planned || 0, remainingTotal);
        const daysLeft = Math.max(0, totalDays - daysFilled);
        const remainingAfterPlanned = Math.max(0, remainingTotal - cappedPlanned);
        const perDayNeeded = daysLeft > 0 ? remainingAfterPlanned / daysLeft : 0;
        const avgSoFar = daysFilled > 0 ? spentSoFar / daysFilled : 0;

        const spentPct = targetTotal > 0 ? spentSoFar / targetTotal : 0;
        const overTarget = spentSoFar > targetTotal;

        function setValue(label, value) {
          setEntries((prev) => ({ ...prev, [label]: parseNumber(value) }));
        }

        function clearAll() {
          let ok = true;
          try {
            ok = window.confirm("Clear all entries?");
          } catch (_) {
            ok = true;
          }
          if (!ok) return;
          setEntries({});
          try {
            localStorage.setItem(
              key,
              JSON.stringify({ startISO, endISO, targetAvg, planned, entries: {} })
            );
          } catch (_) {}
        }

        function dateByIndex(idx) {
          return new Date(startDate.getTime() + idx * 86400000);
        }

        const weekly = useMemo(() => makeWeekly(labels, entries, targetAvg), [labels, entries, targetAvg]);

        return (
          <div className="min-h-screen bg-slate-50 text-slate-900 p-6">
            <div className="max-w-5xl mx-auto">
              <header className="mb-4 flex items-center justify-between gap-3">
                <h1 className="text-2xl font-bold">Daily Spend Tracker for Efo</h1>
                <div className="flex items-center gap-2">
                  <div className="inline-flex rounded-xl bg-slate-200 p-1 mr-2">
                    <button onClick={() => setViewMode('daily')} className={"px-3 py-1 rounded-lg text-sm " + (viewMode==='daily' ? 'bg-white shadow' : 'text-slate-600')}>Daily</button>
                    <button onClick={() => setViewMode('weekly')} className={"px-3 py-1 rounded-lg text-sm " + (viewMode==='weekly' ? 'bg-white shadow' : 'text-slate-600')}>Weekly</button>
                  </div>
                  <button onClick={clearAll} className="px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 text-sm">Clear</button>
                </div>
              </header>

              {/* Calendar + Target/Planned controls */}
              <div className="grid md:grid-cols-4 gap-4 mb-8">
                <div className="p-4 bg-white rounded-2xl shadow">
                  <label className="block text-xs uppercase tracking-wide mb-1">Start date</label>
                  <input type="date" value={startISO} onChange={(e) => setStartISO(e.target.value)} className="w-full border rounded-xl px-3 py-2" />
                </div>
                <div className="p-4 bg-white rounded-2xl shadow">
                  <label className="block text-xs uppercase tracking-wide mb-1">End date</label>
                  <input type="date" value={endISO} onChange={(e) => setEndISO(e.target.value)} className="w-full border rounded-xl px-3 py-2" />
                </div>
                <div className="p-4 bg-white rounded-2xl shadow">
                  <label className="block text-xs uppercase tracking-wide mb-1">Target average / day</label>
                  <input type="number" value={targetAvg} onChange={(e) => setTargetAvg(parseNumber(e.target.value))} className="w-full border rounded-xl px-3 py-2" />
                </div>
                <div className="p-4 bg-white rounded-2xl shadow">
                  <label className="block text-xs uppercase tracking-wide mb-1">Planned future expense</label>
                  <input type="number" value={planned} onChange={(e) => setPlanned(parseNumber(e.target.value))} className="w-full border rounded-xl px-3 py-2" placeholder="0" />
                  <p className="text-xs text-slate-500 mt-2">Capped to remaining budget automatically.</p>
                </div>
              </div>

              {/* Progress section */}
              <div className="grid gap-4 mb-6">
                <ProgressCard
                  title="Spent vs Target"
                  leftLabel={"Spent: " + formatCurrency(spentSoFar)}
                  rightLabel={"Target: " + formatCurrency(targetTotal)}
                  percent={clamp01(spentPct)}
                  barClass={overTarget ? "bg-red-500" : "bg-green-500"}
                  caption={formatCurrency(spentSoFar) + " of " + formatCurrency(targetTotal) + " spent"}
                  truePct={spentPct * 100}
                />
              </div>

              <div className="grid md:grid-cols-4 gap-4 mb-6">
                <StatCard label="Days total" value={totalDays} />
                <StatCard label="Days filled" value={daysFilled} />
                <StatCard label="Avg so far" value={formatCurrency(avgSoFar)} />
                <StatCard label="Spent so far" value={formatCurrency(spentSoFar)} />
              </div>

              <div className="grid md:grid-cols-4 gap-4 mb-6">
                <StatCard label="Target total" value={formatCurrency(targetTotal)} />
                <StatCard label="Remaining total" value={formatCurrency(remainingTotal)} />
                <StatCard label="Remaining after planned" value={formatCurrency(remainingAfterPlanned)} />
                <StatCard label={"Needed per day (" + daysLeft + " left)"} value={formatCurrency(perDayNeeded)} />
              </div>

              {viewMode === 'daily' ? (
                <div className="bg-white rounded-2xl shadow p-4">
                  <div className="flex items-center justify-between mb-3">
                    <h2 className="font-semibold">Enter daily spend</h2>
                    <span className="text-sm text-slate-500">Tip: numbers only; auto-saved</span>
                  </div>
                  <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    {labels.map((label, idx) => {
                      const value = entries[label] ?? 0;
                      const isFilled = Number.isFinite(value) && value !== 0;
                      const isWeekend = [0, 6].includes(dateByIndex(idx).getDay());

                      let boxClass = "group relative border rounded-xl px-3 py-2 flex items-center justify-between transition transform duration-150 hover:shadow-md hover:scale-105";
                      if (isWeekend) boxClass += " border-yellow-400";

                      if (isFilled) {
                        boxClass += value <= targetAvg ? " bg-green-400" : " bg-red-400";
                      }

                      return (
                        <div key={label} className={boxClass} title={isWeekend ? "Weekend" : ""}>
                          {isWeekend && (
                            <span className="pointer-events-none absolute -top-2 left-2 px-1.5 py-0.5 text-[10px] bg-yellow-200 text-yellow-900 rounded shadow opacity-0 group-hover:opacity-100 transition-opacity select-none">
                              Weekend
                            </span>
                          )}
                          <span className="text-sm">{label}</span>
                          <input
                            inputMode="numeric"
                            className="w-28 text-right outline-none bg-transparent"
                            placeholder="0"
                            value={entries[label] ?? ""}
                            onChange={(e) => setValue(label, e.target.value)}
                          />
                        </div>
                      );
                    })}
                  </div>
                </div>
              ) : (
                <div className="bg-white rounded-2xl shadow p-4">
                  <div className="flex items-center justify-between mb-3">
                    <h2 className="font-semibold">Weekly summary</h2>
                    <span className="text-sm text-slate-500">Combined totals in 7‑day buckets</span>
                  </div>
                  <div className="space-y-3">
                    {weekly.map((w) => {
                      const pct = w.target > 0 ? Math.min(1, w.spent / w.target) : 0;
                      const over = w.spent > w.target;
                      return (
                        <div key={w.index}>
                          <div className="flex items-center justify-between text-sm mb-1">
                            <div className="font-medium">Week {w.index} {w.days < 7 ? `(≤ ${w.days} days)` : ""}</div>
                            <div className="text-slate-600">{formatCurrency(w.spent)} / {formatCurrency(w.target)}</div>
                          </div>
                          <div className="w-full h-3 bg-slate-200 rounded-full overflow-hidden">
                            <div className={(over ? 'bg-red-500' : 'bg-green-500') + ' h-3'} style={{ width: (pct * 100) + '%' }}></div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}

              <footer className="text-center text-xs text-slate-500 mt-6">
                Built for quick budgeting. Values are saved in your browser only.
              </footer>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
